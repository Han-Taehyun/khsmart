<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ultarischool.course">
	<select id="selectAllCourseUser"
		parameterType="com.ultarischool.course.CourseExample"
		resultType="com.ultarischool.course.CourseVO">
		SELECT
		sn,courseid,userid,billtype,wdate,price,orgprice,tx,username,title
		FROM vwcosuser

		where 1=1

		<if test="code2 != null and code2 != ''">
			and courseid = #{code2,jdbcType=VARCHAR}
		</if>


		<if test="searchKeyword != null and searchKeyword != ''">
			and ${searchType} LIKE
			CONCAT('%',#{searchKeyword},'%')
		</if>


		LIMIT ${rowStart-1}, 10;
	</select>

	<select id="countAllCourseUser"
		parameterType="com.ultarischool.course.CourseExample"
		resultType="java.lang.Integer">
		SELECT count(*)
		FROM vwcosuser
		where 1=1

		<if test="code2 != null and code2 != ''">
			and courseid = #{code2,jdbcType=VARCHAR}
		</if>

		<if test="searchKeyword != null and searchKeyword != ''">
			and ${searchType} LIKE
			CONCAT('%',#{searchKeyword},'%')
		</if>

	</select>

	<select id="selectAllPkgUser"
		parameterType="com.ultarischool.course.CourseExample"
		resultType="com.ultarischool.course.CourseVO">
		
		SELECT pu.sn,pkgid,pu.userid,wdate,price,billtype,username,pkgtitle
		FROM pkguser pu JOIN usert ut ON ut.userid = pu.userid JOIN package pk
		ON pk.sn = pu.pkgid
		
		<if test="searchKeyword != null and searchKeyword != ''">
			WHERE ${searchType} LIKE
			CONCAT('%',#{searchKeyword},'%')
		</if>
		
		LIMIT ${rowStart-1}, 10;
	</select>

	<select id="countAllPkgUser"
		parameterType="com.ultarischool.course.CourseExample"
		resultType="java.lang.Integer">
		SELECT COUNT(*) FROM

		(SELECT
		pu.sn,pkgid,pu.userid,wdate,price,billtype,username,pkgtitle
		FROM
		pkguser pu JOIN usert ut ON ut.userid = pu.userid JOIN package pk ON
		pk.sn = pu.pkgid) z
		<if test="searchKeyword != null and searchKeyword != ''">
			WHERE c.${searchType} LIKE
			CONCAT('%',#{searchKeyword},'%')
		</if>

	</select>


	<select id="selectAllRateUser"
		parameterType="com.ultarischool.course.CourseExample"
		resultType="com.ultarischool.course.CourseVO">
		SELECT pg.sn,pg.coid,usid,chapid,studtime,pg.runtime,username,cs.title
		, cp.title cptitle, cp.runtime cpruntime,(ROUND(studtime /
		pg.runtime,1) * 100) rate
		FROM progress pg JOIN course cs ON cs.sn =
		pg.coid
		JOIN usert ut ON ut.userid = pg.usid
		JOIN chapter cp ON cp.coid
		= cs.sn AND pg.chapid = cp.sn
		<if test="searchKeyword != null and searchKeyword != ''">
			WHERE c.${searchType} LIKE
			CONCAT('%',#{searchKeyword},'%')
		</if>
		LIMIT ${rowStart-1}, 10;
	</select>

	<select id="countAllRateUser"
		parameterType="com.ultarischool.course.CourseExample"
		resultType="java.lang.Integer">
		SELECT COUNT(*) FROM

		(SELECT
		pg.sn,pg.coid,usid,chapid,studtime,pg.runtime,username,cs.title ,
		cp.title cptitle, cp.runtime cpruntime
		FROM progress pg JOIN course cs
		ON cs.sn = pg.coid
		JOIN usert ut ON ut.userid = pg.usid
		JOIN chapter cp
		ON cp.coid = cs.sn AND pg.chapid = cp.sn) z
		<if test="searchKeyword != null and searchKeyword != ''">
			WHERE c.${searchType} LIKE
			CONCAT('%',#{searchKeyword},'%')
		</if>

	</select>


	<insert id="insCosUserAdmin" parameterType="com.ultarischool.course.CourseVO">
		INSERT cosuser ( courseid, userid, billtype, wdate, price, tx, adminid )

		VALUES ( #{courseid}, #{userid}, 'FREE' , current_timestamp,
		'0','-','')
	</insert>




</mapper>
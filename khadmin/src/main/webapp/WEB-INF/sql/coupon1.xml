<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="khsmart.kr">
	<sql id="includeCoupon1">
		WHERE cu_no != 0
		<if
			test="searchKeyword!=null and searchKeyword!='' and searchType!=''">
			<foreach item="item" index="index" collection="searchTypeArr"
				separator=" OR " open="AND (" close=")">
				${item} LIKE CONCAT('%',
				#{searchKeyword},'%' )
			</foreach>
		</if>

		<if test="orderKeyword=='1'">
			ORDER BY cu_status asc, cu_no desc
		</if>
		<if test="orderKeyword=='2'">
			ORDER BY cu_status desc, cu_no desc
		</if>
		<if test="orderKeyword=='' or orderKeyword==' '">
			ORDER BY cu_no desc
		</if>
	</sql>

	<select id="selectCoupon1Count" resultType="Integer"
		parameterType="edumgt.common.util.SearchVO">
		SELECT COUNT(*) FROM coupont
		<include refid="includeCoupon1" />
	</select>

	<select id="selectMaxCPNO" resultType="String">
		SELECT max(cu_no) FROM
		coupont

	</select>




	<select id="selectCoupon1List"
		resultType="com.khsmart.kr.Coupon1VO"
		parameterType="edumgt.common.util.SearchVO">

		SELECT cu_no,
		cu_kind,
		cu_category,
		cu_subject,
		cu_number,
		case cu_status
		when '1' then '미사용' else cu_memo end cu_status,
		cu_memo,
		cu_use_day,
		cu_use_time,
		format(cu_opt1,0) cu_opt1,

		cu_opt2,

		cu_opt3,
		case when
		CAST(cu_opt1 AS UNSIGNED INTEGER) > 100 then '원' else '%' end
		cu_opt4,
		cu_opt5,
		cu_explan,
		cu_datetime
		FROM coupont

		<include refid="includeCoupon1" />

		LIMIT ${rowStart-1}, 10
	</select>

	<insert id="insertCoupon1"
		parameterType="com.khsmart.kr.Coupon1VO">
		INSERT INTO coupont(cu_kind,
		cu_category,
		cu_subject,
		cu_number,
		cu_status,
		cu_memo,
		cu_use_day,
		cu_use_time,
		cu_opt1,
		cu_opt2,
		cu_opt3,
		cu_opt4,
		cu_opt5,
		cu_explan,
		cu_datetime
		)
		VALUES ( #{cu_kind},
		#{cu_category},
		#{cu_subject},
		#{cu_number},
		'1',
		'',
		#{cu_use_day},
		#{cu_use_time},
		#{cu_opt1},
		#{cu_opt2},
		'0',
		'',
		'Y',
		'',
		CURRENT_TIMESTAMP
		)

	</insert>

	<update id="updateCoupon1"
		parameterType="com.khsmart.kr.Coupon1VO">
		UPDATE coupont
		SET cu_subject = #{cu_subject},
		cu_number =
		#{cu_number},
		cu_use_day = #{cu_use_day},
		cu_use_time = #{cu_use_time},
		cu_opt1 = #{cu_opt1},
		cu_opt2 = #{cu_opt2}

		WHERE cu_no=#{cu_no}
	</update>

	<select id="selectCoupon1One" parameterType="String"
		resultType="com.khsmart.kr.Coupon1VO">
		SELECT cu_no,
		cu_kind,
		cu_category,
		cu_subject,
		cu_number,
		case
		cu_status when '1' then '미사용' else cu_memo end cu_status,
		cu_memo,
		cu_use_day,
		cu_use_time,
		format(cu_opt1,0) cu_opt1,
		cu_opt2,
		cu_opt3,
		case
		when CAST(cu_opt1 AS UNSIGNED INTEGER) > 100 then '원' else '%' end
		cu_opt4,
		cu_opt5,
		cu_explan,
		cu_datetime
		FROM coupont

		WHERE cu_no=#{cu_no}
	</select>

	<delete id="deleteCoupon1One" parameterType="String">
		delete from coupont
		WHERE CAST(cu_no AS CHAR ) = #{cu_no}
	</delete>




	<select id="selectCoupon1Excel"
		resultType="com.khsmart.kr.Coupon1VO"
		parameterType="edumgt.common.util.SearchVO">

		SELECT cu_no,
		cu_kind,
		cu_category,
		cu_subject,
		cu_number,
		case cu_status
		when '1' then '미사용' else cu_memo end cu_status,
		cu_memo,
		cu_use_day,
		cu_use_time,
		format(cu_opt1,0) cu_opt1,
		cu_opt2,
		cu_opt3,
		case when
		CAST(cu_opt1 AS UNSIGNED INTEGER) > 100 then '원' else '%' end
		cu_opt4,
		cu_opt5,
		cu_explan,
		cu_datetime
		FROM coupont

		<include refid="includeCoupon1" />

		LIMIT ${rowStart-1}, 1000
	</select>


	<sql id="includeCoupon2">
		WHERE c_no != 0
		<if
			test="searchKeyword!=null and searchKeyword!='' and searchType!=''">
			<foreach item="item" index="index" collection="searchTypeArr"
				separator=" OR " open="AND (" close=")">
				${item} LIKE CONCAT('%',
				#{searchKeyword},'%' )
			</foreach>
		</if>

		<if test="orderKeyword=='LA'">
			ORDER BY c_no desc
		</if>
		<if test="orderKeyword=='LD'">
			ORDER BY c_no asc
		</if>
		<if test="orderKeyword=='' or orderKeyword==' '">
			ORDER BY c_no desc
		</if>
	</sql>

	<select id="selectCoupon2Count" resultType="Integer"
		parameterType="edumgt.common.util.SearchVO">
		SELECT COUNT(*) FROM couponmember
		<include refid="includeCoupon2" />
	</select>

	<select id="selectMaxTCPId" resultType="String">
		SELECT max(id) FROM
		couponmember

	</select>

	<select id="selectCoupon2List"
		resultType="com.khsmart.kr.Coupon2VO"
		parameterType="edumgt.common.util.SearchVO">

		SELECT c_no,c_id,c_number,c_datetime,
		c_price,
		case when CAST(c_price AS
		UNSIGNED INTEGER) > 100 then '원' else '%' end
		cu_opt4,
		c_price2,c_code,
		c_pcode,
		c_check,
		c_use,

		case c_use when 'Y' then '미사용' else '사용' end as ccc1,

		case concat(c_use,c_check)
		when 'NY' then '쿠폰사용'
		when 'NN' then '미사용(기간만료)' end as ccc2,

		case p_num when '' then '-' else p_num end as p_num,
		d_code,
		tct.cu_subject, tm.username mb_name,tct.cu_memo
		FROM couponmember tcm
		left outer
		join coupont tct on tct.cu_number = tcm.c_number
		left outer join usert
		tm on tm.userid = tcm.c_id


		<include refid="includeCoupon2" />

		LIMIT ${rowStart-1}, 10
	</select>

	<insert id="insertCoupon2"
		parameterType="com.khsmart.kr.Coupon2VO">
		INSERT INTO
		couponmember(lcode,ltitle,ok,file_temp
		,memo,num
		,hi1,hi2,hi3,hi4,hi5,setp
		)
		VALUES ( #{lcode}, #{ltitle}, #{ok}
		,''
		,#{memo}, #{num}
		,#{hi1},#{hi2},#{hi3},#{hi4},#{hi5},#{setp}
		)

	</insert>

	<update id="updateCoupon2"
		parameterType="com.khsmart.kr.Coupon2VO">
		UPDATE couponmember
		SET ltitle=#{ltitle},lcode=
		#{lcode},ok= #{ok},num= #{num},memo= #{memo}

		,hi1=#{hi1},hi2=#{hi2},hi3=#{hi3},hi4=#{hi4},hi5=#{hi5},setp=#{setp}

		WHERE id=#{id}
	</update>

	<select id="selectCoupon2One" parameterType="String"
		resultType="com.khsmart.kr.Coupon2VO">
		SELECT c_no,
		c_id,
		c_number,
		c_datetime,
		c_price,
		c_price2,
		c_code,
		c_pcode,
		c_check,
		c_use,
		p_num,
		d_code, tct.cu_subject
		FROM
		couponmember
		tcm
		join coupont tct on tct.cu_number = tcm.c_number

		WHERE
		c_no=#{c_no}
	</select>



</mapper>

